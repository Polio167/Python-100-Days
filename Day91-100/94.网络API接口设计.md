## 網路API介面設計

目前許多的Web應用和移動應用都使用了前後端分離的開發模式，前後端分離簡單的說就是前端或移動端透過網路API介面和後臺進行互動，獲得介面中提供的資料並負責使用者介面的渲染。API是應用程式的程式設計介面的縮寫，網路API通常指的是基於一個URL（統一資源定位符）可以訪問到的資源，也就是說透過這個URL我們就可以請求伺服器對某個資源進行操作並返回操作的結果。大家可以想想，網路API介面不也是一種封裝嗎，簡單的說就是將複雜的業務邏輯隱藏在簡單的API介面中。

URL的通用格式如下所示：

```
協議://使用者名稱:口令@主機:埠/路徑1/.../路徑N/資源名
```

> **說明**：URL中的使用者名稱（有可能不需要提供使用者名稱）、口令（有可能不需要提供口令）、埠（有可能使用預設埠）、路徑（資源有可能直接位於根路徑`/`下）並不是必需的部分，可以根據需要進行設定。

網路API通常基於HTTP或HTTPS進行訪問，基於HTTP/HTTPS最大的好處就在於訪問起來非常的簡單方便，而且可以跨語言、跨應用進行訪問和互操作。

### 設計原則

#### 關鍵問題

為移動端或者PC端設計網路API介面一個非常重要的原則是：**根據業務實體而不是使用者介面或操作來設計API介面**。如果API介面的設計是根據使用者的操作或者介面上的功能設定來設計，隨著需求的變更，使用者介面也會進行調整，需要的資料也在發生變化，那麼後端開發者就要不停的調整API，或者給一個API設計出多個版本，這些都會使專案的開發和維護成本增加。我們可以將業務實體理解為伺服器提供的資源，而URL就是資源的定位符（識別符號），這種方式是最為簡單自然的。對於相對複雜的使用者操作，我們可以提供一個“門面”（設計模式中的“門面模式”），透過該“門面”把多個介面的功能組裝起來即可。

下面是某個網站開放API的介面，可以看出API的設計是圍繞業務實體來進行的，而且都做到了“見名知意”。

| 評論              |                        |
| ----------------- | ---------------------- |
| comments/show     | 獲取某條微博的評論列表 |
| comments/by_me    | 自己的評論列表         |
| comments/to_me    | 收到的評論列表         |
| comments/mentions | @了自己的評論列表      |
| comments/create   | 建立一條評論           |
| comments/destroy  | 刪除一條評論           |
| comments/reply    | 回覆一條評論           |

需要說明的是，**上面的API介面並不是REST風格的**。REST是一種網路應用架構風格，被認為最適合分散式的網路應用。關於REST的知識，可以閱讀阮一峰的[《理解RESTful架構》](http://www.ruanyifeng.com/blog/2011/09/restful.html)以及[《RESTful API設計指南》](http://www.ruanyifeng.com/blog/2014/05/restful_api.html)，當然這兩篇文章大家也要批判的閱讀，因為上面闡述的觀點並不完全正確，有些內容甚至是自相矛盾的。

API介面返回的資料通常都是**JSON**或**XML**格式，XML這種資料格式目前基本已經被棄用了。對於JSON格式的資料，我們需要做到不要返回null這的值，因為這樣的值一旦處置失當，會給前端和移動端開發帶來不必要的麻煩（因為開發者有可能會使用強型別語言）。要解決這個問題可以從源頭入手，在設計資料庫的時候，儘量給每個欄位都加上“not null”約束或者設定合理的預設值約束。

#### 其他問題

1. 更新提示問題：設計一個每次使用系統首先要訪問的API，該API會向移動端返回系統更新的相關資訊，這樣就可以提升使用者更新App了。
2. 版本升級問題：API版本升級時應該考慮對低版本的相容，同時要讓新版本和舊版本都能夠被訪問，可以在URL中包含版本資訊或者在將版本號放在HTTP(S)協議頭部，關於這個問題有很多的爭論，有興趣的可以看看[stack overflow](https://stackoverflow.com/questions/972226/how-to-version-rest-uris)上面對這個問題的討論。
3. 圖片尺寸問題：移動端對於一張圖片可能需要不同的尺寸，可以在獲取圖片時傳入尺寸引數並獲取對應的資源；更好的做法是直接使用雲端儲存或CDN（直接提供了圖片縮放的功能），這樣可以加速對資源的訪問。

### 文件撰寫

下面以設計評論介面為例，簡單說明介面文件應該如何撰寫。

首先，我們可以定義全域性返回狀態碼。

| 返回碼 | 返回資訊     | 說明                               |
| ------ | ------------ | ---------------------------------- |
| 10000  | 獲取評論成功 |  |
| 10001 | 建立評論成功 |  |
| 10002  | 無法建立評論 | 建立評論時因違反稽核機制而無法建立 |
| 10003 | 評論已被刪除     | 檢視評論時評論因不和諧因素已被刪除                |
| 10004 | …… | …… |

1. 獲取文章評論。

   **GET** `/articles/{article-id}/comments/`

   開發者：王大錘

   最後更新時間：2018年8月10日

   標籤：v 1.0

   介面說明：獲取指定文章的所有評論

   使用幫助：預設返回20條資料，需要在請求頭中設定身份標識（key）

   請求引數：

   | 引數名 | 型別   | 是否必填 | 引數位置 | 說明                                 |
   | ------ | ------ | -------- | -------- | ------------------------------------ |
   | page   | 整數   | 否       | 查詢引數 | 頁碼，預設值1                        |
   | size   | 整數   | 否       | 查詢引數 | 每次獲取評論數量（10~100），預設值20 |
   | key    | 字串 | 是       | 請求頭   | 使用者的身份標識                       |

   響應資訊：

   ```JSON
   {
       "code": 10000,
       "message": "獲取評論成功",
       "page": 1,
       "size": 10,
       "totalPage": 35,
       "contents": [
           {
               "userId": 1700095,
               "nickname": "王大錘",
               "pubDate": "2018年7月31日",
               "content": "小編是不是有病呀",
               /* ... */
           },
           {
           	"userId", 1995322,
               "nickname": "白元芳",
               "pubDate": "2018年8月2日",
               "content": "樓上說得好",
               /* ... */
           }
       ]
       /* ... */
   }
   ```

2. 新增文章評論。

   **POST** `/articles/{article-id}/comments`

   開發者：王大錘

   最後更新時間：2018年8月10日

   標籤：v 1.0

   介面說明：為指定的文章建立評論

   使用幫助：暫無

   請求引數：

   | 引數名  | 型別   | 是否必填 | 引數位置 | 說明       |
   | ------- | ------ | -------- | -------- | ---------- |
   | userId  | 字串 | 是       | 訊息體   | 使用者ID     |
   | key     | 字串 | 是       | 請求頭   | 使用者的令牌 |
   | content | 字串 | 是       | 訊息體   | 評論的內容 |

   響應資訊：

   ```JSON
   {
       "code": 10001,
       "message": "建立評論成功",
       "comment": {
           "pubDate": "2018年7月31日",
           "content": "小編是不是有病呀"
           /* ... */
       }
       /* ... */
   }
   ```



> **提示**：如果沒有介面文件撰寫經驗，可以使用線上介面文件編輯平臺[RAP2](<http://rap2.taobao.org/>)或[YAPI](<http://yapi.demo.qunar.com/>)來進行介面文件撰寫。

